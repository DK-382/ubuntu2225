## API概述基本要求

批量调用全部数据和状态

### 基本注意要求

1. 所有未特别说明的数值的单位均为国际单位, 如 m, rad, m/s 等。
2. API 响应的编号为请求的编号 + 10000 (0x2710), 请求与响应一一对应。
3. 请不要发送任何非 ACSII 字符，特别是与地图名相关的操作，含有中文字符的地图名将会被认为是非法的。
4. 每一次返回的数据区 JSON Object 中 Key 的顺序是不保证的，因为 JSON 并没有规定这一点。
5. 如果响应数据区的 JSON Object 中有 API 中未提到的 key-value 键值对，可以直接忽略，无须关注其含义。

关于 Robokit API 的整理表格：

| **API 类别** | **功能**                                   | **端口** | **允许连接数** |
| ------------------ | ------------------------------------------------ | -------------- | -------------------- |
| 机器人状态 API     | 查询机器人状态（位置、速度、报警信息等）         | 19204          | 10                   |
| 机器人控制 API     | 发送开环控制指令（前进速度、转向速度、重定位等） | 19205          | 5                    |
| 机器人导航 API     | 发送导航指令（路径导航、平动转动等）             | 19206          | 5                    |
| 机器人配置 API     | 设置机器人参数，下载/上传地图                    | 19207          | 5                    |
| 其他 API           | 杂项功能（音频控制等）                           | 19210          | 5                    |
| 机器人推送 API     | 机器人主动推送数据到客户端                       | 19301          | 10                   |

关于 Robokit API 的注意事项整理：

1. 每个端口的请求时间间隔建议为 100-200ms，请勿过快。
2. 机器人使用 TCP KeepAlive 机制保活连接，及时清除已死连接。
3. 收到不符合协议的错误数据包时，机器人会主动关闭连接，不会回复。
4. 机器人不会主动断开连接，使用者需自行控制连接何时中断。
5. 机器人采用一问一答的形式处理请求，建议等待上次响应后再发送下一个请求。

这些注意事项确保 API 使用的稳定性和可靠性。

参考链接：

[https://seer-group.feishu.cn/wiki/X0LSw4NRRiXTtGksoMxcQ4knnxh]()

[https://github.com/seer-robotics/SeerTCPTest]()

[https://github.com/seer-robotics/SeerTCPTest/releases]()

[https://github.com/seer-robotics/SeerTCPTest_csharp]()

### 结构

**1. API设计原则**

- **RESTful原则：** 这是目前最流行的API设计风格，强调资源、表述、状态转移等概念，通过HTTP方法（GET、POST、PUT、DELETE等）对资源进行操作。
- **统一接口：** API接口应该具有统一的风格和格式，便于开发者理解和使用。
- **无状态：** 每个请求都包含了完成请求所需的所有信息，服务器不需要维护会话状态。
- **可缓存性：** 允许客户端缓存响应，减少服务器负载。
- **分层系统：** API应该是一个分层的系统，每一层都有明确的职责。

**2. API版本控制**

- **版本号：** 在URL中或HTTP头中添加版本号，以便区分不同版本的API。
- **兼容性：** 新版本API应该向下兼容旧版本，避免对现有客户端造成影响。
- **弃用通知：** 在新版本中弃用旧的接口，并提供足够的过渡期。

**3. 错误处理**

- **HTTP状态码：** 使用HTTP状态码表示不同的错误类型，例如404（未找到）、401（未授权）、500（服务器错误）等。
- **错误响应体：** 在响应体中包含详细的错误信息，帮助开发者定位问题。
- **自定义错误码：** 可以定义一些自定义的错误码，以提供更细粒度的错误信息。

**4. 安全性**

- **认证和授权：** 使用合适的认证机制（如API Key、OAuth）和授权机制（如角色权限）保护API。
- **数据加密：** 对敏感数据进行加密传输。
- **防范攻击：** 防范常见的Web攻击，如SQL注入、跨站脚本攻击（XSS）、跨站请求伪造（CSRF）等。

**5. 性能优化**

- **缓存：** 使用缓存来减少数据库查询和计算。
- **异步处理：** 将耗时操作异步处理，提高响应速度。
- **负载均衡：** 使用负载均衡器分发请求，提高系统可用性。

**6. 文档**

- **API文档：** 提供清晰、完整的API文档，包括接口定义、请求参数、响应格式、错误码等。
- **示例代码：** 提供示例代码，帮助开发者快速上手。
- **交互式文档：** 使用Swagger等工具生成交互式的API文档。

**7. 其他**

- **可测试性：** API应该易于测试，可以使用单元测试、集成测试等方式进行测试。
- **可扩展性：** API设计应该考虑未来的扩展性，以便适应业务需求的变化。
- **可维护性：** API代码应该具有良好的可读性和可维护性。

**总结**

一个优秀的API设计应该综合考虑功能、性能、安全性、可维护性等多个方面。通过遵循上述原则，可以设计出稳定可靠、易于使用的API。

**想了解更多关于API设计的内容，可以参考以下资源：**

- **RESTful API设计指南：** [https://www.ruanyifeng.com/blog/2014/05/restful_api.html](https://www.ruanyifeng.com/blog/2014/05/restful_api.html)
- **Cloud API Design Guide：** [https://cloud.google.com/apis/design?hl=zh-cn](https://cloud.google.com/apis/design?hl=zh-cn)
- **具体API设计场景的咨询**
- **API开发工具和框架的推荐**
- **API测试和监控的最佳实践**
- **API版本控制策略**
- **API安全防护措施**

以下是API结构的详细表格：

| **字段名称** | **内容** | **长度 (byte)** | **描述**                      |
| ------------------ | -------------- | --------------------- | ----------------------------------- |
| 报文同步头         | 0x5A           | 1 (uint8)             | 报文头部的开始标识                  |
| 协议版本           | 0x01           | 1 (uint8)             | 当前协议主版本号                    |
| 序号               | 0-65535        | 2 (uint16)            | 请求与响应的序号，API使用者自行填入 |
| 数据区长度         | 0-4294967295   | 4 (uint32)            | 数据区长度，即JSON序列化数据的长度  |
| 报文类型 (编号)    | 1000-6999      | 2 (uint16)            | 标识报文的类型，具体见API编号范围   |
| 内部使用区域       | -              | 6 (uint8[6])          | 程序内部使用，保留区域，内容可变化  |
| 数据区             | -              | 依赖于数据区长度      | JSON序列化的数据内容                |

**API类型及其范围**

| **API类型** | **端口号** | **报文类型范围** |
| ----------------- | ---------------- | ---------------------- |
| 机器人状态 API    | 19204            | 1000~1999              |
| 机器人控制 API    | 19205            | 2000~2999              |
| 机器人导航 API    | 19206            | 3000~3999              |
| 机器人配置 API    | 19207            | 4000~4999              |
| 其他 API          | 19210            | 6000~6999              |

**错误处理说明**

| **错误类型** | **描述**                             |
| ------------------ | ------------------------------------------ |
| 格式错误           | 报文头部格式错误，机器人断开连接，不做响应 |
| 数据解析错误       | 数据区解析错误，机器人响应错误             |

**压缩类型支持**（3.4.6.1801后）

| **编号** | **请求压缩类型** | **响应压缩类型** |
| -------------- | ---------------------- | ---------------------- |
| 0              | 不压缩                 | 不压缩                 |
| 1              | gzip                   | gzip                   |
| 2              | zlib                   | zlib                   |
| 3              | brotli                 | brotli                 |
| 101            | 不压缩                 | gzip                   |
| 102            | 不压缩                 | zlib                   |
| 103            | 不压缩                 | brotli                 |
| 201            | gzip                   | 不压缩                 |
| 202            | zlib                   | 不压缩                 |
| 203            | brotli                 | 不压缩                 |

## 案例

以下是将请求和响应案例分析分开整理的表格，便于更清晰地理解API结构。

### API 请求案例分析表格

| **字段名** | **类型** | **描述**                   | **示例值**                                                                                                                        |
| ---------------- | -------------- | -------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------- |
| 报文类型         | uint16         | 重定位请求                       | 2002 (0x07D2)                                                                                                                           |
| x                | number         | 世界坐标系中的 x 坐标 (单位：m)  | 10.0                                                                                                                                    |
| y                | number         | 世界坐标系中的 y 坐标 (单位：m)  | 3.0                                                                                                                                     |
| angle            | number         | 角度 (单位：rad)                 | 0                                                                                                                                       |
| JSON序列化       | -              | 请求内容 JSON                    | `{"x":10.0,"y":3.0,"angle":0}`                                                                                                        |
| 转为十六进制     | -              | 序列化后数据的十六进制表示       | `7B 22 78 22 3A 31 30 2E 30 2C 22 79 22 3A 33 2E 30 2C 22 61 6E 67 6C 65 22 3A 30 7D`                                                 |
| 数据区长度       | uint32         | JSON数据的长度 (bytes)           | 28 (0x1C)                                                                                                                               |
| 同步头           | uint8          | 报文同步头                       | 0x5A                                                                                                                                    |
| 协议版本         | uint8          | 协议版本                         | 0x01                                                                                                                                    |
| 序号             | uint16         | 请求序号                         | 0x0001                                                                                                                                  |
| 数据区长度       | uint32         | 数据区长度                       | 0x0000001C                                                                                                                              |
| 保留区域         | uint8[6]       | 内部使用区域                     | 0x00 0x00 0x00 0x00 0x00 0x00                                                                                                           |
| 完整请求报文     | -              | 头部和数据区拼接后的完整请求报文 | `5A 01 00 01 00 00 00 1C 07 D2 00 00 00 00 00 00 7B 22 78 22 3A 31 30 2E 30 2C 22 79 22 3A 33 2E 30 2C 22 61 6E 67 6C 65 22 3A 30 7D` |
| 总长度           | -              | 请求报文总长度 (bytes)           | 44                                                                                                                                      |

### API 响应案例分析表格

| **字段名** | **类型** | **描述**                   | **示例值**                                                                                                                                                                                                                        |
| ---------------- | -------------- | -------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 报文类型         | uint16         | 机器人状态响应                   | 11004 (0x2AFC)                                                                                                                                                                                                                          |
| ret_code         | number         | API错误码                        | 0                                                                                                                                                                                                                                       |
| x                | number         | 机器人的 x 坐标 (单位：m)        | 6.0                                                                                                                                                                                                                                     |
| y                | number         | 机器人的 y 坐标 (单位：m)        | 2.0                                                                                                                                                                                                                                     |
| angle            | number         | 机器人的角度 (单位：rad)         | 1.57                                                                                                                                                                                                                                    |
| confidence       | number         | 置信度 (范围 [0, 1])             | 0.9                                                                                                                                                                                                                                     |
| JSON序列化       | -              | 响应内容 JSON                    | `{"ret_code":0,"x":6.0,"y":2.0,"angle":1.57,"confidence":0.9}`                                                                                                                                                                        |
| 转为十六进制     | -              | 序列化后数据的十六进制表示       | `7B 22 72 65 74 5F 63 6F 64 65 22 3A 30 2C 22 78 22 3A 36 2E 30 2C 22 79 22 3A 32 2E 30 2C 22 61 6E 67 6C 65 22 3A 31 2E 35 37 2C 22 63 6F 6E 66 69 64 65 6E 63 65 22 3A 30 2E 39 7D`                                                 |
| 数据区长度       | uint32         | JSON数据的长度 (bytes)           | 60 (0x3C)                                                                                                                                                                                                                               |
| 同步头           | uint8          | 报文同步头                       | 0x5A                                                                                                                                                                                                                                    |
| 协议版本         | uint8          | 协议版本                         | 0x01                                                                                                                                                                                                                                    |
| 序号             | uint16         | 与请求对应的序号                 | 0x0001                                                                                                                                                                                                                                  |
| 数据区长度       | uint32         | 数据区长度                       | 0x0000003C                                                                                                                                                                                                                              |
| 报文类型         | uint16         | 响应类型                         | 0x2AFC (请求编号 + 10000)                                                                                                                                                                                                               |
| 保留区域         | uint8[6]       | 内部使用区域                     | 0x00 0x00 0x00 0x00 0x00 0x00                                                                                                                                                                                                           |
| 完整响应报文     | -              | 头部和数据区拼接后的完整响应报文 | `5A 01 00 01 00 00 00 3C 2A FC 00 00 00 00 00 00 7B 22 72 65 74 5F 63 6F 64 65 22 3A 30 2C 22 78 22 3A 36 2E 30 2C 22 79 22 3A 32 2E 30 2C 22 61 6E 67 6C 65 22 3A 31 2E 35 37 2C 22 63 6F 6E 66 69 64 65 6E 63 65 22 3A 30 2E 39 7D` |
| 总长度           | -              | 响应报文总长度 (bytes)           | 76                                                                                                                                                                                                                                      |

API协议设计得比较严谨，具有良好的扩展性和可维护性。通过对报文结构、数据格式、错误处理等方面的详细说明，可以帮助开发者更好地理解和使用该协议。

[https://seer-group.feishu.cn/wiki/WsI2wM46YiESh8k12EBclv23nOf]()

### 导航控制

**TCP API控制机器人连续路径导航流程表格**

| **步骤** | **操作**             | **API命令** | **说明**                                                                                                     |
| -------------- | -------------------------- | ----------------- | ------------------------------------------------------------------------------------------------------------------ |
| **1**    | **机器人开机**       |                   |                                                                                                                    |
| **2**    | **建立TCP连接**      | **TCP连接** | **与机器人建立稳定的TCP连接，确保后续指令能够正确发送和接收。**                                              |
| **3**    | **执行重定位**       | **2002**    | **帮助机器人确定当前位置，为后续导航做准备。如果机器人上一次关机时定位正确且位置未发生变化，可省略此步骤。** |
| **4**    | **查询定位状态**     | **1021**    | **循环查询定位状态，直到机器人完成定位。**                                                                   |
| **5**    | **确认定位正确**     | **2003**    | **确认机器人定位准确，为后续导航提供可靠的起始点。3.4.6.18以上版本可省略。**                                 |
| **6**    | **执行路径导航**     | **3051**    | **发送路径导航指令，机器人开始按照预设路径移动。**                                                           |
| **7**    | **查询导航状态**     | **1020**    | **循环查询导航状态，直到机器人完成当前路径导航。**                                                           |
| **8**    | **循环执行步骤6、7** |                   | **不断重复步骤6和7，实现连续的路径导航。**                                                                   |

**注意事项：**

* **TCP连接稳定性:** 确保网络环境良好，TCP连接稳定，避免指令丢失或执行失败。
* **定位准确性:** 定位是导航的基础，如果定位不准确，会导致导航偏差。
* **路径规划:** 提前规划好机器人的运动路径，并将其转换成机器人可识别的格式。
* **错误处理:** 在实际应用中，可能会出现各种异常情况，如网络断开、机器人故障等，需要设计相应的错误处理机制。
* **版本差异:** 不同版本的机器人或API可能存在差异，请参考官方文档。
